import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, updateDoc, deleteDoc, addDoc, getDocs } from 'firebase/firestore';
import { LogIn, UserPlus, Mail, Lock, Calendar, Image, Eye, EyeOff, Settings, Home, Users, PlusCircle, CheckCircle, Trash2, Edit, LogOut, XCircle } from 'lucide-react'; // For icons

// Context for Firebase and User
const AppContext = createContext();

const AppProvider = ({ children }) => {
  const [app, setApp] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    try {
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
      const initializedApp = initializeApp(firebaseConfig);
      const firestoreDb = getFirestore(initializedApp);
      const firebaseAuth = getAuth(initializedApp);

      setApp(initializedApp);
      setDb(firestoreDb);
      setAuth(firebaseAuth);

      const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          try {
            if (typeof __initial_auth_token !== 'undefined') {
              await signInWithCustomToken(firebaseAuth, __initial_auth_token);
            } else {
              await signInAnonymously(firebaseAuth);
            }
            setUserId(firebaseAuth.currentUser?.uid || crypto.randomUUID());
          } catch (error) {
            console.error("Firebase authentication error:", error);
            setUserId(crypto.randomUUID()); // Fallback to a random ID if auth fails
          }
        }
        setIsAuthReady(true);
        setLoading(false);
      });

      return () => unsubscribe();
    } catch (error) {
      console.error("Firebase initialization error:", error);
      setLoading(false);
      setIsAuthReady(true); // Mark as ready even if there's an error
    }
  }, []);

  if (loading || !isAuthReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-white">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
          <p className="mt-4 text-lg text-gray-700">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶¨‡¶∏... ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®! üöÄ</p>
        </div>
      </div>
    );
  }

  return (
    <AppContext.Provider value={{ app, db, auth, userId, isAuthReady }}>
      {children}
    </AppContext.Provider>
  );
};

// Custom Hook to use App Context
const useAppContext = () => {
  return useContext(AppContext);
};

// Message Box Component
const MessageBox = ({ message, type, onClose }) => {
  const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
  const textColor = 'text-white';

  return (
    <div className={`fixed inset-0 flex items-center justify-center z-50 p-4`}>
      <div className="absolute inset-0 bg-black opacity-50"></div>
      <div className={`${bgColor} ${textColor} p-6 rounded-lg shadow-xl max-w-sm w-full relative`}>
        <p className="text-lg font-semibold mb-4">{message}</p>
        <button
          onClick={onClose}
          className="absolute top-2 right-2 text-white hover:text-gray-200"
        >
          <XCircle size={24} />
        </button>
      </div>
    </div>
  );
};

// Main App Component
const App = () => {
  const { db, auth, userId, isAuthReady } = useAppContext();
  const [currentPage, setCurrentPage] = useState('welcome'); // welcome, register, login, feed, people, privacy, admin
  const [message, setMessage] = useState('');
  const [messageType, setMessageType] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [users, setUsers] = useState([]);
  const [posts, setPosts] = useState([]);
  const [loggedInUser, setLoggedInUser] = useState(null);
  const [showAdminPanel, setShowAdminPanel] = useState(false);
  const [secretCodeInput, setSecretCodeInput] = useState('');
  const [adminUsers, setAdminUsers] = useState([]);
  const [appLogo, setAppLogo] = useState('https://placehold.co/60x60/000/fff?text=B'); // Default app logo
  const [editUserModal, setEditUserModal] = useState(null); // User being edited in admin panel
  const [editUserDisplayName, setEditUserDisplayName] = useState('');
  const [editUserPhotoURL, setEditUserPhotoURL] = useState('');


  // User State for Register/Login
  const [realName, setRealName] = useState('');
  const [dob, setDob] = useState('');
  const [profilePicture, setProfilePicture] = useState(null);
  const [profilePicturePreview, setProfilePicturePreview] = useState('https://placehold.co/80x80/cccccc/000?text=DP');
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  // Post State
  const [newPostContent, setNewPostContent] = useState('');

  // Fetch all users for admin panel
  useEffect(() => {
    if (db && isAuthReady && showAdminPanel) {
      const usersColRef = collection(db, `artifacts/${__app_id}/public/data/users`);
      const unsubscribe = onSnapshot(usersColRef, (snapshot) => {
        const usersList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setAdminUsers(usersList);
      }, (error) => {
        console.error("Error fetching admin users:", error);
        showMessage("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
      });
      return () => unsubscribe();
    }
  }, [db, isAuthReady, showAdminPanel]);


  // Fetch all users for "People" tab
  useEffect(() => {
    if (db && isAuthReady) {
      const usersColRef = collection(db, `artifacts/${__app_id}/public/data/users`);
      const unsubscribe = onSnapshot(usersColRef, (snapshot) => {
        const usersList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setUsers(usersList);
      }, (error) => {
        console.error("Error fetching users:", error);
        showMessage("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
      });
      return () => unsubscribe();
    }
  }, [db, isAuthReady]);

  // Fetch posts for "Feed" tab
  useEffect(() => {
    if (db && isAuthReady) {
      const postsColRef = collection(db, `artifacts/${__app_id}/public/data/posts`);
      const q = query(postsColRef);
      const unsubscribe = onSnapshot(q, (snapshot) => {
        const postsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // Sort posts by timestamp in descending order
        postsList.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        setPosts(postsList);
      }, (error) => {
        console.error("Error fetching posts:", error);
        showMessage("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
      });
      return () => unsubscribe();
    }
  }, [db, isAuthReady]);

  // Check for logged-in user on app load
  useEffect(() => {
    if (auth && isAuthReady) {
      const unsubscribe = onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDocRef = doc(db, `artifacts/${__app_id}/public/data/users`, user.uid);
          try {
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
              setLoggedInUser({ id: user.uid, ...userDocSnap.data() });
              setCurrentPage('feed'); // Go to feed if logged in
            } else {
              // User exists in auth but not in Firestore, maybe a new anonymous user
              // Or a user created via Google Connect that hasn't completed profile
              console.log("User exists in auth but not in Firestore. Redirecting to welcome.");
              setCurrentPage('welcome');
            }
          } catch (error) {
            console.error("Error fetching logged in user data:", error);
            showMessage("‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
            setCurrentPage('welcome');
          }
        } else {
          setCurrentPage('welcome');
        }
      });
      return () => unsubscribe();
    }
  }, [auth, db, isAuthReady]);


  // Effect to load app logo from Firestore
  useEffect(() => {
    if (db && isAuthReady) {
      const appConfigDocRef = doc(db, `artifacts/${__app_id}/public/data/appConfig`, 'main');
      const unsubscribe = onSnapshot(appConfigDocRef, (docSnap) => {
        if (docSnap.exists() && docSnap.data().appLogo) {
          setAppLogo(docSnap.data().appLogo);
        }
      }, (error) => {
        console.error("Error fetching app logo:", error);
      });
      return () => unsubscribe();
    }
  }, [db, isAuthReady]);


  const showMessage = (msg, type) => {
    setMessage(msg);
    setMessageType(type);
  };

  const closeMessage = () => {
    setMessage('');
    setMessageType('');
  };

  const handleProfilePictureChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setProfilePicture(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setProfilePicturePreview(reader.result);
      };
      reader.readAsDataURL(file);
    } else {
      setProfilePicture(null);
      setProfilePicturePreview('https://placehold.co/80x80/cccccc/000?text=DP');
    }
  };

  const handleRegister = async () => {
    if (!realName || !dob || !username || !password || !confirmPassword) {
      showMessage("‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶¨‡¶∏! üßê", "error");
      return;
    }
    if (password !== confirmPassword) {
      showMessage("‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡ßá‡¶≤‡ßá‡¶®‡¶ø, ‡¶¨‡¶∏! üòÖ", "error");
      return;
    }
    if (password.length < 6) {
      showMessage("‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§", "error");
      return;
    }

    try {
      // Check if username already exists
      const usersRef = collection(db, `artifacts/${__app_id}/public/data/users`);
      const q = query(usersRef, where("username", "==", username));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        showMessage("‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error");
        return;
      }

      const userCredential = await createUserWithEmailAndPassword(auth, `${username}@bytebird.com`, password);
      const user = userCredential.user;

      const userDocRef = doc(db, `artifacts/${__app_id}/public/data/users`, user.uid);
      await setDoc(userDocRef, {
        realName,
        dob,
        username,
        profilePicture: profilePicturePreview, // Storing base64 for simplicity, ideally upload to storage
        isVerified: false,
        createdAt: Date.now(),
      });

      setLoggedInUser({ id: user.uid, realName, dob, username, profilePicture: profilePicturePreview, isVerified: false });
      showMessage("‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üéâ", "success");
      setCurrentPage('feed');
    } catch (error) {
      console.error("Registration error:", error);
      let errorMessage = "‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = "‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ (‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ) ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§";
      }
      showMessage(errorMessage, "error");
    }
  };

  const handleLogin = async () => {
    if (!username || !password) {
      showMessage("‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®, ‡¶¨‡¶∏! üîë", "error");
      return;
    }

    try {
      const userCredential = await signInWithEmailAndPassword(auth, `${username}@bytebird.com`, password);
      const user = userCredential.user;

      const userDocRef = doc(db, `artifacts/${__app_id}/public/data/users`, user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (userDocSnap.exists()) {
        setLoggedInUser({ id: user.uid, ...userDocSnap.data() });
        showMessage("‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ü•≥", "success");
        setCurrentPage('feed');
      } else {
        // This case should ideally not happen if registration creates the Firestore doc
        // But as a fallback, if auth user exists but firestore doc doesn't
        await signOut(auth); // Sign out the auth user
        showMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error");
        setCurrentPage('register');
      }
    } catch (error) {
      console.error("Login error:", error);
      let errorMessage = "‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
        errorMessage = "‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡•§";
      }
      showMessage(errorMessage, "error");
    }
  };

  const handleLogout = async () => {
    try {
      await signOut(auth);
      setLoggedInUser(null);
      showMessage("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ üëã", "success");
      setCurrentPage('welcome');
    } catch (error) {
      console.error("Logout error:", error);
      showMessage("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
    }
  };

  const handleCreatePost = async () => {
    if (!newPostContent.trim()) {
      showMessage("‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï‡¶ü‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®, ‡¶¨‡¶∏! ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§ üìù", "error");
      return;
    }
    if (!loggedInUser) {
      showMessage("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error");
      return;
    }

    try {
      const postsColRef = collection(db, `artifacts/${__app_id}/public/data/posts`);
      await addDoc(postsColRef, {
        userId: loggedInUser.id,
        username: loggedInUser.username,
        realName: loggedInUser.realName,
        profilePicture: loggedInUser.profilePicture,
        content: newPostContent.trim(),
        timestamp: Date.now(),
        likes: 0,
        dislikes: 0,
        comments: 0,
        isVerified: loggedInUser.isVerified || false,
      });
      setNewPostContent('');
      showMessage("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‚ú®", "success");
    } catch (error) {
      console.error("Error creating post:", error);
      showMessage("‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
    }
  };

  const handlePrivacyPolicyClick = () => {
    setCurrentPage('privacy');
  };

  const handleSecretCodeSubmit = () => {
    if (secretCodeInput === "Jay Radhe Krishna 108") {
      setShowAdminPanel(true);
      showMessage("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, ‡¶¨‡¶∏! üëë", "success");
    } else {
      showMessage("‡¶≠‡ßÅ‡¶≤ ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶ï‡ßã‡¶°! üö®", "error");
    }
    setSecretCodeInput('');
  };

  // Admin Panel Functions
  const handleVerifyUser = async (userToVerify) => {
    try {
      const userDocRef = doc(db, `artifacts/${__app_id}/public/data/users`, userToVerify.id);
      await updateDoc(userDocRef, { isVerified: !userToVerify.isVerified });
      showMessage(`${userToVerify.username} ${userToVerify.isVerified ? '‡¶Ü‡¶®-‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á' : '‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á'} ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, "success");
    } catch (error) {
      console.error("Error verifying user:", error);
      showMessage("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
    }
  };

  const handleDeleteUser = async (userToDelete) => {
    try {
      // Delete user's posts first
      const postsColRef = collection(db, `artifacts/${__app_id}/public/data/posts`);
      const q = query(postsColRef, where("userId", "==", userToDelete.id));
      const querySnapshot = await getDocs(q);
      const deletePromises = querySnapshot.docs.map(docToDelete => deleteDoc(doc(db, `artifacts/${__app_id}/public/data/posts`, docToDelete.id)));
      await Promise.all(deletePromises);

      // Delete user document
      const userDocRef = doc(db, `artifacts/${__app_id}/public/data/users`, userToDelete.id);
      await deleteDoc(userDocRef);

      // Note: Firebase Auth user deletion would require server-side logic
      // For this client-side app, we only remove the Firestore profile.

      showMessage(`${userToDelete.username} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ üóëÔ∏è`, "success");
    } catch (error) {
      console.error("Error deleting user:", error);
      showMessage("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
    }
  };

  const handleEditUser = (user) => {
    setEditUserModal(user);
    setEditUserDisplayName(user.realName);
    setEditUserPhotoURL(user.profilePicture);
  };

  const handleSaveUserEdit = async () => {
    if (!editUserModal) return;
    try {
      const userDocRef = doc(db, `artifacts/${__app_id}/public/data/users`, editUserModal.id);
      await updateDoc(userDocRef, {
        realName: editUserDisplayName,
        profilePicture: editUserPhotoURL,
      });
      showMessage(`${editUserDisplayName} ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, "success");
      setEditUserModal(null);
    } catch (error) {
      console.error("Error updating user profile:", error);
      showMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
    }
  };

  const handleAppLogoChange = async (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = async () => {
        const newLogo = reader.result;
        try {
          const appConfigDocRef = doc(db, `artifacts/${__app_id}/public/data/appConfig`, 'main');
          await setDoc(appConfigDocRef, { appLogo: newLogo }, { merge: true });
          setAppLogo(newLogo);
          showMessage("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶ó‡ßã ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üé®", "success");
        } catch (error) {
          console.error("Error updating app logo:", error);
          showMessage("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶ó‡ßã ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", "error");
        }
      };
      reader.readAsDataURL(file);
    }
  };


  // Render different pages based on currentPage state
  const renderPage = () => {
    switch (currentPage) {
      case 'welcome':
        return (
          <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-white p-4 text-center">
            <img src={appLogo} alt="Bytebird Logo" className="w-24 h-24 mb-4 rounded-full shadow-lg" />
            <h1 className="text-4xl font-bold text-gray-800 mb-2">Bytebird</h1>
            <p className="text-md text-gray-600 mb-8">by BrajYugal Creatives</p>
            <p className="text-2xl font-semibold text-gray-700 mb-8">Voice of India</p>

            <div className="w-full max-w-xs space-y-4">
              <button
                onClick={() => setCurrentPage('register')}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 flex items-center justify-center"
              >
                <UserPlus className="mr-2" /> ‡¶è‡¶ñ‡¶®‡¶á ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®
              </button>
              <button
                onClick={() => showMessage("Google Connect ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶æ‡¶∞‡¶ø‡¶§‡¶æ ‡¶è‡¶ñ‡¶®‡ßã ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡¶Ø‡¶º‡•§ üöß", "error")}
                className="w-full bg-white hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-lg shadow-md border border-gray-300 transition duration-300 flex items-center justify-center"
              >
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="w-5 h-5 mr-2" /> Google ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
              </button>
              <button
                onClick={() => showMessage("‡¶ó‡ßá‡¶∏‡ßç‡¶ü ‡¶Æ‡ßã‡¶° ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶æ‡¶∞‡¶ø‡¶§‡¶æ ‡¶è‡¶ñ‡¶®‡ßã ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡¶Ø‡¶º‡•§ üöß", "error")}
                className="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 flex items-center justify-center"
              >
                ‡¶ó‡ßá‡¶∏‡ßç‡¶ü ‡¶Æ‡ßã‡¶°‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
              </button>
            </div>

            <p className="mt-8 text-sm text-gray-500">
              <span onClick={handlePrivacyPolicyClick} className="cursor-pointer text-blue-600 hov
